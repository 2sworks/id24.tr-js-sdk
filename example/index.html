<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Identify JS Sdk Video Çağrı - Örnek</title>
    <link rel="stylesheet" href="./assets/app.css">
</head>
<body>

<div class="config-container active">
    <div class="status connected">SDK ayarlarını tanımlayınız</div>

    <h3>Ident</h3>
    <div class="form-group"><input type="text" id="ident_id" placeholder="Ident Id"></div>

    <h3>Opsiyonlar</h3>
    <div class="form-row col-2">
        <label for="language">Dil</label>
        <select id="language" name="language">
            <option value="tr">Türkçe</option>
        </select>

        <label for="sign_lang">İşaret Dili</label>
        <select id="sign_lang" name="sign_lang">
            <option value="true">Evet</option>
            <option value="false">Hayır</option>
        </select>
    </div>

    <h3>API</h3>
    <div class="form-group">
        <input type="text" id="api-url" placeholder="API">
    </div>

    <h3>Stun</h3>
    <div class="form-row col-2">
        <input type="text" id="stun-ip" placeholder="Stun IP">
        <input type="text" id="stun-port" placeholder="Stun Port">
    </div>

    <h3>Turn</h3>
    <div class="form-row col-4">
        <input type="text" id="turn-ip" placeholder="Turn IP">
        <input type="text" id="turn-port" placeholder="Turn Port">
        <input type="text" id="turn-username" placeholder="Turn Kullanıcı">
        <input type="text" id="turn-pass" placeholder="Turn Şifre">
    </div>

    <h3>Log Seviyesi</h3>
    <select id="logLevel" name="logLevel">
        <option value="-1">Kapalı</option>
        <option value="0">Acil (Emergency)</option>
        <option value="1">Alarm (Alert)</option>
        <option value="2">Kritik (Critical)</option>
        <option value="3">Hata (Error)</option>
        <option value="4">Uyarı (Warning)</option>
        <option value="5">Bildirim (Notice)</option>
        <option value="6">Bilgi (Info)</option>
        <option value="7">Hata Ayıklama (Debug)</option>
    </select>

    <div class="buttons">
        <button class="btn btn-prev" onclick="saveLocalStorage()">Tarayıcıma Kaydet</button>
        <button class="btn btn-next" onclick="goMoveCall()">İleri</button>
    </div>
</div>

<div class="call-container">
    <div class="status waiting" id="callStatus">SDK Kurulumu Bekleniyor...</div>

    <div class="video-preview" style="display: none">
        <h4>Müşteri Görüntüsü</h4>
        <video id="myVideo" autoplay="" playsinline="" class="h"
               muted="muted"></video>
    </div>

    <div class="video-preview" style="display: none">
        <h4>Temsilci Görüntüsü</h4>
        <video id="peerVideo" autoplay="" playsinline="" loop
               muted="muted"></video>
    </div>

    <div class="buttons">
        <button class="btn btn-wait" onclick="initializeSDK()">1. SDK Kurulum</button>
        <button class="btn btn-call" onclick="startIdentification()">2. Identification Süreçlerini Başlat</button>
        <button class="btn btn-end" onclick="again()">Yeniden Başlat</button>
    </div>
</div>

<script src="./assets/app.js"></script>
<script src="https://raw.githubusercontent.com/2sworks/id24.tr-js-sdk/2.4.6/dist/identify-sdk.bundle.min.js"></script>
<script type="text/javascript">
    let identifyObject = null;
    let config = null;

    async function initializeSDK() {
        if (context.isInitialized) {
            alert("SDK Kurulumu zaten yapıldı");

            return;
        }

        if (!IdentifySDK.IdentifySdk.checkBrowserCompatibility()) {
            changeMessage('Tarayıcınız desteklenmiyor. Lütfen Chrome 60+, Firefox 55+, Edge 79+, Safari 12.1+, Opera 47+ sürümlerinden birini kullanın.');
            return
        }

        config = getFormConfig();

        const identityOptions = new IdentifySDK.IdentifyOptionBuilder()
            .setIdentityType([IdentifySDK.IdentifyModuleTypes.AGENT_CALL])
            .build();

        identifyObject = await new IdentifySDK.IdentifySdkBuilder()
            .setApi(config.api_url)
            .setStun(config.stun.ip, config.stun.port)
            .setTurn(config.turn.ip, config.turn.port, config.turn.username, config.turn.pass)
            .setLogLevel(config.logLevel)
            .setLifeCycle({
                socket: {
                    onConnectionLost() {
                        error();
                    },
                    onError(data) {
                        error(data);
                    }
                },
                videoCall: {
                    onQueueUpdate(data) {
                        if (data.countMember === 0) {
                            changeMessage('Temsilcinin müşteriyi karşılaması bekleniyor, Temsilci çağrı yapmaya hazırlanıyor');
                        } else {
                            changeMessage('Temsilcinin müşteriyi karşılaması bekleniyor, Sıra = ' + data.countMember + ' Ortalama Bekleme süresi (DK) = ' + data.apprWaitFor);
                        }
                    },
                    onCancel(data) {
                        missCall();
                    },
                    onCall(data) {
                        answerCall();
                    },
                    onTerminate() {
                        endCall()
                    },
                    onRefuse(message) {
                        refuseCall(message);
                    }
                }
            })
            .setOptions(identityOptions)
            .build();

        context.isInitialized = true;
        changeMessage('SDK Kurulumu Yapıldı, Identifacation Süreçlerinin başlatılması bekleniyor...');
    }

    async function startIdentification() {
        if (!context.isInitialized) {
            alert("SDK Kurulumu yapmış olmanız gerekiyor");
            return;
        }

        if (context.isIdentificationStarted) {
            alert("Identification süreçleri zaten başlatıldı");

            return;
        }

        await identifyObject.startIdentification(config.ident_id, config.language, config.sign_lang)
            .then(msg => {
                changeMessage('Bağlantı başarılı, süreçler ilerletiliyor...');
                context.isIdentificationStarted = true;
            })
            .catch(err => {
                alert("Bağlantı hatası: " + err.message);
                error(err.message)
            });
    }

    async function answerCall() {
        document.querySelectorAll(".video-preview").forEach(el => {
            el.style.display = "";
        });

        await identifyObject.answerCallWithElements(document.getElementById('myVideo'), document.getElementById('peerVideo'));

        changeMessage('Çağrı başladı');
    }

    async function endCall() {
        document.querySelectorAll(".video-preview").forEach(el => {
            el.style.display = "none";
        });

        changeMessage('Çağrı Sonlandırıldı');

        await identifyObject.close();
    }

    async function refuseCall(message) {
        document.querySelectorAll(".video-preview").forEach(el => {
            el.style.display = "none";
        });

        changeMessage('Çağrı red edildi. Hata = ' + message);
    }

    async function missCall() {
        document.querySelectorAll(".video-preview").forEach(el => {
            el.style.display = "none";
        });

        changeMessage('Çağrı İptal Edildi veya Zaman Aşımına Uğradı');
    }

    async function error(data) {
        document.querySelectorAll(".video-preview").forEach(el => {
            el.style.display = "none";
        });

        changeMessage('Hata Alındı / Bağlantı Koptu' + (data ? 'Mesaj : ' + data : ''));
    }
</script>

</body>
</html>